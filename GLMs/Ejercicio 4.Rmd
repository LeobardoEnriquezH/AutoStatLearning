---
title: "Ejercicio 4"
author: 'Equipo #'
date: "2024-03-31"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,message = F,warning = F,fig.width = 5, fig.height = 2.9)
```


```{r,echo=FALSE,message=FALSE,warning=FALSE}
library(tidyverse)
library(kableExtra)
library(ggplot2)
library(cowplot)
library(stargazer)
library(knitr)
library(dplyr)
library(readr)
library(car)
library(MASS)
library(ggResidpanel)
library(DHARMa)
```


## 4. Modelos lineales generalizados para datos de conteos

La base de datos Preg4.csv contiene información sobre el número de casos de cáncer de pulmón (Cases) registrados entre 1968 y 1971 en cuatro ciudades de Dinamarca (City). En estos casos se registró también la edad de los pacientes (Age, variable categorizada en 5 grupos). El interés del análisis es estudiar si se puede indicar que a mayor edad existe mayor incidencia de cáncer de pulmón. Notemos que para realizar el análisis la variable de conteos Cases depende de forma inherente de la población de la ciudad (Pop), pues entre más grande la ciudad es mayor el número de casos que se pueden observar; de manera que el estudio se debe enfocar en las tasas de incidencia.



# i) Gráfica de dispersión de grupos de edad e incidencia


```{r,echo=FALSE,message=FALSE,warning=FALSE}
data4 <- read_csv("Preg4.csv")
```

```{r,echo=FALSE,message=FALSE,warning=FALSE}
#Primero haremos factor las variables de ciudad y edad
data4$City <- as.factor(data4$City)
```

```{r,echo=FALSE,message=FALSE,warning=FALSE}
#Tambien crearemos la variable que indicara la tasa de incidencia
data4$incidencia <- data4$Cases/data4$Pop
```


```{r,echo=FALSE}
ggplot(data=data4, aes(x=Age,y=incidencia, colour=City))+ geom_point()+ theme_classic()+
  theme(text = element_text(size = 11),element_line(linewidth =0.5))
```

Podemos apreciar de la siguiente gráfica presentada que por cada grupo de edad la incidencia en cada ciudad va en aumento, por ejemplo en el grupo de edad de 40-54 la incidencia de cáncer esta por debajo de 0.005 pero conforme avanzan los grupos de edad los niveles aumentan para todas las ciudades

# ii) Distribución Poisson con liga logarítmica y un segundo modelo.

Como primer modelo consideraremos uno con distribución Poisson y función log, ademas de considerar las demás covariables de Age y City con su interacción 


```{r,echo=FALSE,message=F,warning=FALSE}
fit_poisson <- glm(Cases ~ incidencia + Age * City, data = data4, family = poisson(link = "log"))
summary(fit_poisson)
```

```{r,echo=FALSE}
#Toda esta parte de verificacion de supuestos del primer modelo se omitira en el pdf pero se dejara aqui en codigo

#Ya que ajustamos el primer modelo comenzaremos a verificar los supuestos del mismo. Para comenzar realizaremos la prueba de dedo para ver si se cumple el supuesto de la media igual a la varianza.
```

```{r,echo=FALSE}
#Ya que ajustamos el primer modelo comenzaremos a verificar los supuestos del mismo. Para comenzar realizaremos la prueba de dedo para ver si se cumple el supuesto de la media igual a la varianza.
```



```{r,echo=FALSE,message=FALSE,warning=FALSE}
#deviance(fit_poisson)/df.residual(fit_poisson)
```
```{r,echo=FALSE}
#En este caso tenemos un valor muy alejado de 1 lo cual nos indica que este supuesto no se esta cumpliendo, es decir, tenemos que la media no es igual a la varianza.

#Veamos como se comportan los demás supuestos.
```


```{r,echo=FALSE,message=FALSE,warning=FALSE}
#resid_panel(fit_poisson, plots=c("all"))
```

```{r,echo=FALSE,message=FALSE,warning=FALSE}
#set.seed(123)
#fit1res <- simulateResiduals(fittedModel = fit_poisson)
#plot(fit1res )
```

De las verificaciones de los supuestos para el primer modelo observamos que tenemos muchos problemas con los mismos del modelo por lo que optaremos por ajustar un segundo modelo, con la diferencia de que solo incluiremos a la covariable Age sin interacción.

```{r,echo=FALSE,message=FALSE,warning=FALSE}
fit_poisson2 <- glm(Cases ~ I(incidencia^1.8) + Age , data = data4, family = poisson(link = "log"))
summary(fit_poisson2)
```

Veamos si este modelo para la regle de dedo:

```{r,echo=FALSE,message=FALSE,warning=FALSE}
deviance(fit_poisson2)/df.residual(fit_poisson2)
```
Tenemos como resultado un valor cercano a 1 por lo que pasaremos a verificar los supuestos del modelo.


```{r,echo=FALSE,message=FALSE,warning=FALSE}
#se omitiran las graficas en panel por motivos de espacio
#resid_panel(fit_poisson2, plots=c("all"))
#set.seed(123)
fit1res2 <- simulateResiduals(fittedModel = fit_poisson2)
plot(fit1res2)
par(mfrow = c(2, 2))
```

De la gráfica podemos notar que no parece tener problemas con la Q-Q Plot. 


Notamos que este nuevo modelo mejora bastante respecto al primero en el que se incluían mas covariables y ya no presenta los mismos problemas que el primer ajuste realizado tomando la interacción de las covariables.

Lo que sigue sera hacer una prueba anova en la que compararemos ambos modelo y decidir si se puede usar el segundo modelo.

```{r,echo=FALSE,message=FALSE,warning=FALSE}
anova(fit_poisson,fit_poisson2, test = "Chisq")
```
De la prueba de bondad de ajuste notamos que no se rechaza H0 por lo que se puede usar el segundo modelo para los datos.
Ademas comparado los AIC de ambos modelos tenemos por un lado que el primer modelo tuvo como resultado 121.47 contra 102.59 del segundo modelo en el cual se corrigieron problemas de con los supuestos.


# iii)Modelo binomial negativo. Comparación con el anterior.


```{r,echo=FALSE,message=FALSE,warning=FALSE}
fit_negbin <- glm.nb(Cases ~ incidencia + Age , data = data4, link = "log")
summary(fit_negbin)
```

```{r,echo=FALSE}
#Verifiquemos los supuestos de este modelo con DHARMa
#En este caso nuevamente omitiremos los resultados de las pruebas de los supuestos para este modelo ya que no se usara debido a que se escogio como mejor ajuste el modelo anterior 
```


```{r,echo=FALSE,message=FALSE,warning=FALSE}
#set.seed(123)
#fit_negativ <- simulateResiduals(fittedModel = fit_negbin)
#plot(fit_negativ)
```

```{r,echo=FALSE}
#Podemos decir que este también parece ser buen modelo, al menos es mucho mejor #que el primero, sin embargo no parece ser mejor que el segundo modelo.

#Comparemos los AIC y BIC de los ultimos 2 modelos para ver cual es mejor en este #aspecto.
```


```{r,echo=FALSE,message=FALSE,warning=FALSE}
c(AIC(fit_poisson2), AIC(fit_negbin))
c(BIC(fit_poisson2), BIC(fit_negbin))
```
Como ya habíamos mencionado el segundo modelo Poisson resulto mejor que el modelo ajustado con Binomial negativa.
Finalmente haremos intervalos de confianza simultáneos con el modelo Poisson 2 que para nosotros resulto ser el mejor de los 3.

## Intervalos

```{r,echo=FALSE}
#Para los intervalos de confianza lo que haremos sera definir una malla de valores para la edad ya que nos interesa saber si a mayor edad existe mayor incidencia de cancer de pulmon
```

```{r,echo=FALSE,message=FALSE,warning=FALSE}
library(MASS)
edad <- seq(from = 40, to =74, by = .5)
```


```{r,echo=FALSE,message=FALSE,warning=FALSE}
#el calculo de los intervalos los haremos a una confianza del 95%
#E(y;x)= b0 + b1 incidencia^1.8  + b2 Age
library(multcomp)
k <- cbind(0,0,0,0,-1,-edad)
#banda del primer grupo de edad


fite <- glht(fit_poisson2, linfct = k)
fitci2 <- confint(fite, level = 0.95)


plot(edad, coef(fite), col="black", type="l", main="Incidencia de Cáncer por Edad")+
lines(edad, fitci2$confint[,"upr"], col="black")+
lines(edad, fitci2$confint[,"lwr"], col="black")+
abline(h=25, col="blue")
```

De los resultados obtenidos en la gráfica con los intervalos podemos ver que aproximadamente a partir de los 57-58 años de edad la incidencia de cáncer de pulmón en las ciudades de Dinamarca va en aumento,cosa que ya se podía observar en la gráfica presentada en el primer punto del ejercicio.















