---
title: "Ejercicio 4"
author: 'Equipo #'
date: "2024-03-31"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,message = F,warning = F,fig.width = 5, fig.height = 2.9)
```


```{r,echo=FALSE,message=FALSE,warning=FALSE}
library(tidyverse)
library(kableExtra)
library(ggplot2)
library(cowplot)
library(stargazer)
library(knitr)
library(dplyr)
library(readr)
library(car)
library(MASS)
library(ggResidpanel)
library(DHARMa)
```


## 4. Modelos lineales generalizados para datos de conteos

La base de datos Preg4.csv contiene información sobre el número de casos de cáncer de pulmón (Cases) registrados entre 1968 y 1971 en cuatro ciudades de Dinamarca (City). En estos casos se registró también la edad de los pacientes (Age, variable categorizada en 5 grupos). El interés del análisis es estudiar si se puede indicar que a mayor edad existe mayor incidencia de cáncer de pulmón. Notemos que para realizar el análisis la variable de conteos Cases depende de forma inherente de la población de la ciudad (Pop), pues entre más grande la ciudad es mayor el número de casos que se pueden observar; de manera que el estudio se debe enfocar en las tasas de incidencia.



# i) Gráfica de dispersión de grupos de edad e incidencia


```{r,echo=FALSE,message=FALSE,warning=FALSE}
data4 <- read_csv("Preg4.csv")
```

```{r,echo=FALSE,message=FALSE,warning=FALSE}
#Primero haremos factor las variables de ciudad y edad
data4$City <- as.factor(data4$City)
```

```{r,echo=FALSE,message=FALSE,warning=FALSE}
#Tambien crearemos la variable que indicara la tasa de incidencia
data4$incidencia <- data4$Cases/data4$Pop
```


```{r,echo=FALSE}
ggplot(data=data4, aes(x=Age,y=incidencia, colour=City))+ geom_point()+ theme_classic()+
  theme(text = element_text(size = 11),element_line(linewidth =0.5))
```

Podemos apreciar de la siguiente gráfica presentada que por cada grupo de edad la incidencia en cada ciudad va en aumento, por ejemplo en el grupo de edad de 40-54 la incidencia de cáncer esta por debajo de 0.005 pero conforme avanzan los grupos de edad los niveles aumentan para todas las ciudades

# ii) Distribución Poisson con liga logarítmica y un segundo modelo.

Como primer modelo consideraremos uno con distribución Poisson y función log, ademas de considerar las demás covariables de Age y City con su interacción 


```{r,echo=FALSE,message=FALSE,warning=FALSE}
#Lo que nos interesa es ver si es estudiar si se puede indicar que a mayor edad existe mayor incidencia de cancer de pulmon

# Notar que para dejar en terminos de la variable con conteos,
# al considerar la liga log se debe incluir log(data4$Pop) [offset]

#### log(mu_y/t)=b0+b1x
####    log(mu_y)=log(t)+b0+b1x

data4$log=log(data4$Pop)

ajuste1 <- glm(Cases ~ offset(log)+ Age * City , family=poisson(link="log"), data=data4)
summary(ajuste1)
```

```{r,echo=FALSE,message=FALSE,warning=FALSE}
# Regla de dedo para analizar si hay un problema por 
# considerar el parametro de dispersion igual a 1
#deviance(ajuste1)/df.residual(ajuste1)

#library(DHARMa)  
#set.seed(1234)
#fitres <- simulateResiduals(fittedModel = ajuste1)
#plot(fitres)

#De la regla del dedo obtuvimos un valor de -inf, lo cual nos dice que no es un bueno modelo, de todas formas se hizo la verificacion de los supuestos pero salio muy mal en estos por lo que se decidio no usarse
```

De las verificaciones de los supuestos para el primer modelo observamos que tenemos muchos problemas con los mismos del modelo por lo que optaremos por ajustar un segundo modelo, con la diferencia de que solo incluiremos a la covariable Age sin interacción.


```{r,echo=FALSE,message=FALSE,warning=FALSE}
ajuste2 <- glm(Cases ~ offset(log) + Age , family=poisson(link="log"), data=data4)
summary(ajuste2)
```

Veamos si este modelo para la regle de dedo:

```{r,echo=FALSE,message=FALSE,warning=FALSE}
#Regla de dedo para analizar si hay un problema por 
# considerar el parametro de dispersion igual a 1
deviance(ajuste2)/df.residual(ajuste2)
library(DHARMa)  
set.seed(1234)
fitres_2 <- simulateResiduals(fittedModel = ajuste2)
plot(fitres_2)
```

Para este segundo modelo en el que solo se toma como covariable a la edad tuvimos un valor muy cercano a 1 con la regla del dedo, lo cual nos dice que es buen modelo, por lo que procedimos con la verificación de los supuestos del modelo con los cuales no parece tener ningún problema.

Lo que sigue sera hacer una prueba anova en la que compararemos ambos modelo y decidir si se puede usar el segundo modelo.

```{r,echo=FALSE,message=FALSE,warning=FALSE}
anova(ajuste1,ajuste2, test = "Chisq")
```


Como obtuvimos un p-value mayor que 0.05 no tenemos evidencia suficiente para rechazar la hipótesis nula, por lo que concluimos que no se tiene una mejora significativa tomando mas variables y su interacción.Adicional mente tenemos que el AIC del modelo con Age como única covariable es menor que el que incluye la interacción por lo que tenemos las herramientas suficientes para descartar dicho modelo.


# iii)Modelo binomial negativo. Comparación con el anterior.


```{r,echo=FALSE,message=FALSE,warning=FALSE}
library(MASS)
fit_negbin3 <- glm.nb(Cases ~ offset(log)+ Age , data = data4, link = "log")
summary(fit_negbin3)
```

```{r,echo=FALSE}
#Verifiquemos los supuestos de este modelo con DHARMa
#En este caso nuevamente omitiremos los resultados de las pruebas de los supuestos para este modelo ya que no se usara debido a que se escogio como mejor ajuste el modelo anterior 
```


```{r,echo=FALSE,message=FALSE,warning=FALSE}
#set.seed(123)
#fit_neg <- simulateResiduals(fittedModel = fit_negbin3)
#plot(fit_neg)
```

```{r,echo=FALSE}
#Podemos decir que este tambien parece ser buen modelo, al menos es mucho mejor #que el primero, sin embargo no parece ser mejor que el segundo modelo.

#Comparemos los AIC y BIC de los ultimos 2 modelos para ver cual es mejor en este #aspecto.
```

```{r,echo=FALSE,message=FALSE,warning=FALSE}
c(AIC(ajuste2), AIC(fit_negbin3))
c(BIC(ajuste2), BIC(fit_negbin3))
```

Como ultimo criterio para escoger modelo final compararemos los resultados tanto del AIC como del BIC para los modelos poisson con covariable edad vs el binomial negativo, donde es claro que el mejor fue el poisson.

Finalmente haremos intervalos de confianza simultáneos con el modelo Poisson 2 que para nosotros resulto ser el mejor de los 3.

## Intervalos

```{r,echo=FALSE,message=FALSE,warning=FALSE}
#Para los intervalos de confianza lo que haremos sera definir una malla de valores para la edad.
```

```{r,echo=FALSE,message=FALSE,warning=FALSE}
library(MASS)
Edad <- seq(from = 40, to =74, by = .5)
```

```{r,echo=FALSE,message=FALSE,warning=FALSE}
#el calculo de los intervalos los haremos a una confianza del 95%
#E(y;x)= b0 + b1 incidencia^1.8  + b2 Age
library(multcomp)
K_1 <- cbind(0,0,0,1,Edad)
#banda del primer grupo de edad


fittI <- glht(ajuste2, linfct = K_1)
fitci3 <- confint(fittI, level = 0.95)


plot(Edad, coef(fittI), col="black", type="l", main="Incidencia de Cáncer por Edad")+
lines(Edad, fitci3$confint[,"upr"], col="red")+
lines(Edad, fitci3$confint[,"lwr"], col="red")+
abline(h=110, col="blue")

#Aplicando la funcion inversa para obtener los valores sobre la esperanza de y, omitiremos este resultado, sin embargo es de utilidad para saber en que nivel nos permite obtener estimaciones directas de la media esperada de la variable de respuesta en el espacio original de la variable de respuesta, lo que facilita su interpretación y comparación con otros datos o modelos. Esto es especialmente útil cuando estamos interesados en las predicciones en la escala original de la variable de respuesta, en lugar de en la escala del predictor lineal.
#exp(fitci3$confint)
```

De los resultados obtenidos en la gráfica con los intervalos podemos ver que aproximadamente a partir de los 57-58 años de edad la incidencia de cáncer de pulmón en las ciudades de Dinamarca va en aumento,cosa que ya se podía observar en la gráfica presentada en el primer punto del ejercicio.

Habiendo realizado todo el análisis, podemos decir que la edad si jugo un papel importante en el modelo y nos ayudo a ver de forma mas clara y concisa que en efecto para las ciudades estudiadas por el equipo de investigadores en todas se incrementa la incidencia de cancer pulmonar conforme avanzan los años.














