---
title: "Ejercicio 2_"
author: "Equipo"
date: "2024-03-26"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



```{r, echo=FALSE, include=FALSE}
library(tidyverse)
library(stargazer)
library(kableExtra)

```


## 2. Modelos lineales generalizados para datos continuos

Consideraremos la base de datos ``Preg1B.csv`` con información sobre 295 pacientes seleccionados de forma aleatoria. Se desea analizar si existe una asociación entre la presión arterial sistólica (bpsystol) y el índice de masa corporal (bmi), considerando el sexo (sex: 1-hombre, 2-mujer, con hombre como referencia) y la edad (age) de los pacientes. 



i. Explorando los diferentes modelos lineales generalizados comúnmente usados cuando la variable dependiente es continua (normal, gamma, inversa gaussiana), presente un modelo que le parezca adecuado para modelar E(bpsystol; bmi, sex, age). Considere por simplicidad que no hay interacción entre las covariables del modelo. Deberá indicar con claridad cuál es la expresión matemática que se usa para modelar E(bpsystol; bmi, sex, age), así como describir el procedimiento y criterio usado para seleccionar el modelo.


ii. Repita los incisos iii) y iv) de la pregunta 1 con el modelo en i).



iii. Comparando el modelo en i) con el usado en la pregunta 1, compare las conclusiones e interpretaciones que se pueden obtener e indique qué modelo prefiere usar. Argumente con claridad su respuesta, por ejemplo, debe incluir los valores de AIC o BIC, así como ventajas y desventajas en la interpretación.


### i) Explorando modelos con variable dependiente contínua. 

Para presentar un modelo que parezca adecuado para modelar E(bpsystol; bmi, sex, age), exploramos una malla de los diferentes modelos lineales generalizados comúnmente usados: para el componente aleatorio cuando la variable dependiente es continua exploramos las distribuciones normal, gamma, e inversa gaussiana;  empleamos distintas funciones ligas tales como la inversa, identidad, logarítmica, y 1/mu^2(solo para IG); y consideramos el componente lineal tanto de potencias (-3, -2.5, ..., 2.5, 3) como de polinomios (grado 1 al 5). Consideramos por simplicidad que no hay interacción entre las covariables del modelo.  En el siguiente Cuadro se muestraa el mejor modelo, con el menor AIC de 2484.009 (que coincide con el mejor modelo por su BIC de 2502.443), con la siguiente estructura: 

glm(formula = bpsystol ~ age+sex+I(bmi^(1.5)), family = inverse.gaussian(link = identity ), data = datos). 


```{r, echo=FALSE}
datos<-read_csv("Preg1B.csv", show_col_types = FALSE)
datos$sex<-factor(datos$sex) #declaramos la variable como factor
#Realizamos un relevel para poner como referencia "1"
datos$sex<-relevel(datos$sex,"1")
```



```{r, echo=FALSE}
#Seleccionar un modelo entre un conjunto de posibles glm, mediante mallas

#Comp lineal: a)transf BoxTidwell(potencias) a x y b) polinomio sobre x
#Mallas para el valor de potencia y grado de polinomio:
malla=seq(from = 1, to = 5, by = 1)
Poli <- cbind("poly", malla)
malla=seq(from = -3, to = 3, by = .5)
Pot <- cbind("pot", malla)
CompLin=rbind(Poli, Pot)


#Componente aleatorio: Y es continua y positiva, tenemos tres opciones: 
#Malla con distribucion Normal, Gausiana e Inversa Gausiana
Distribuciones=c("gaussian", "Gamma", "inverse.gaussian")

#Funcion liga:inverse, identity, log, y 1/mu^2(solo para IG)
FunLigas=c("identity", "log", "inverse", "1/mu^2")

#Declaramos longitud o dimensión de los vectores
nFunLigas=length(FunLigas)
nDist=length(Distribuciones)
nCompLin=dim(CompLin)[1]

#Creación de variables para guardar resultados
ModelList=list(NA)  #guardar resultados del ajuste, objeto glm
AICList=list(NA)    #guardar el AIC del modelo
BICList=list(NA)    #guardar el BIC del modelo
FormList=list(NA)   #guardar la formula usada para el ajuste

#Modelos 18*2*3+18*1*4(tres funciones ligas para 2 distrib y 4 para una, IG)
```


```{r, echo=FALSE}
#Generamos los cíclos y combinaciones de las mallas
index=0
for(k in 1:nCompLin){
  #definimos componente lineal y formula
  if(CompLin[k,1]=="poly"){
    formstring=paste0("bpsystol ~ age+sex+poly(bmi,",  CompLin[k,2], ", raw=TRUE)")
  }else{
    if(CompLin[k,2]==0){
      formstring=paste0("bpsystol ~ age+sex+I(log(bmi))")}else
      {
        formstring=paste0("bpsystol ~ age+sex+I(bmi^(",  CompLin[k,2], "))")}
  }
  form <- as.formula(formstring)
  for(j in 1:nDist){
    for(l in 1:nFunLigas){
      #definicion del argumento family
      if(FunLigas[l]=="1/mu^2"){
        if(Distribuciones[j]=="inverse.gaussian"){
          index=index+1
          Dist=get(Distribuciones[j])  #obtener la funcion a usar
          Mod.A.Prueba=glm(form, data=datos, family = Dist(link=FunLigas[l]))
          ModelList[[index]]=Mod.A.Prueba
          AICList[[index]]=AIC(Mod.A.Prueba)
          BICList[[index]]=BIC(Mod.A.Prueba)
          FormList[[index]]=formstring
        }
      }else{
        index=index+1
        Dist=get(Distribuciones[j])
        Mod.A.Prueba=glm(form, data=datos, family = Dist(link=FunLigas[l]))
        ModelList[[index]]=Mod.A.Prueba
        AICList[[index]]=AIC(Mod.A.Prueba)
        BICList[[index]]=BIC(Mod.A.Prueba)
        FormList[[index]]=formstring
      }
    }
  }
}

```



```{r, echo=FALSE}
#El modelo con menor AIC

MinAIC=which.min(unlist(AICList))
ModMinAIC=ModelList[[MinAIC]]
summary(ModMinAIC)

```



```{r, echo=FALSE}
ModMinAIC$family


AICList[[MinAIC]]
BICList[[MinAIC]]
FormList[[MinAIC]]
```



```{r, echo=FALSE}
#Indice del modelo con menor BIC

#MinBIC=which.min(unlist(BICList))
#ModMinBIC=ModelList[[MinBIC]]
#summary(ModMinBIC)
#ModMinBIC$family

#AICList[[MinBIC]]
#BICList[[MinBIC]]
#FormList[[MinBIC]]
```



Sin embargo, se elige el modelo más simple o parsimonioso sin el exponente de $1.5$ para la variable bmi, pues al considerar bmi sin modificación se obtiene un AIC  de 2484.1, el cual no parece ser muy diferente a 2484.009.  En el siguiente Cuadro se muestra el modelo final elegido, cuya expresión matemática es $xx$.  



```{r, echo=FALSE}
modelo_glm1<-glm(formula = bpsystol ~ age+sex+bmi, family = inverse.gaussian(link = identity), data = datos)
summary(modelo_glm1)
```

En las siguientes gráficas podemos observar en **Residuals vs Fitted** que se conserva la linealidad, en **Q-Q Residuals** se observa un buen comportamiento de la normalidad de los errores, en **Scale-Location** se observa que hay homoscedasticidad, y en **Residuals vs Leverage** parece no haber outliers influyentes.  


```{r, echo=FALSE}
par(mfrow = c(2, 2))
plot(modelo_glm1)
```


```{r, echo=FALSE}
#par(mfrow = c(2, 2))
#####check_model function of performance package: Grphs####
pkgs <- c(
  "flextable", "performance", "see", "lmtest", "ggplot2",
  "qqplotr", "ggrepel", "patchwork", "boot", "rempsyc", "report"
)
#install.packages(pkgs)

library(flextable)
library(performance)
library(see)
library(lmtest)
library(qqplotr)
library(ggrepel)
library(patchwork)
library(boot)
library(rempsyc)
library(report)

#check_model(modelo1) #check_model() function of the performance package

###check_model function of performance package: p-values ###

#check_collinearity(modelo1) # VIF
#check_autocorrelation(modelo1) #  Autocorrelated residuals p value
#check_heteroscedasticity(modelo1) # non-constant error variance (heteroscedasticity): p value
#check_outliers(modelo1) # Outliers method and threshold: cook
# check_normality(modelo1) # Normality of residuals p value


table_tests2<-nice_assumptions(modelo_glm1)
table_tests_fin2<-subset(table_tests2, select = -c(Model,Diagnostic) )

kable(t(table_tests_fin2)) %>%
kable_styling(bootstrap_options = "striped", full_width = F)
```




### ii) Asociación entre masa corporal y presión arterial sistólica, y estimación puntual. 

En esta sección describiremos por una parte la asociación entre masa corporal y presión arterial sistólica y la prueba de hipótesis de esta relación. Por otra presentaremos una gráfica resumen con la estimación puntual de la relación bpsystol y bmi, considerando  edades de 30, 50 y 64, así como la diferenciación entre mujeres y hombres. 



### iii) Comparativo modelo de regresión lineal múltiple contra modelo lineal generalizado. 

En esta sección se compara  modelo de regresión lineal múltiple del ejercicio anterior (ejercicio 1) contre el modelo lineal generalizado con base en sus AIC. Además, compararemos las conslusiones e interpretaciones de ambos modelos, para indicar cuál nos parece más adecuado. 

